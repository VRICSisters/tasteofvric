<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Judges Panel - Taste of VRIC</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 600px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            padding: 40px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }
        
        h1 {
            color: #333;
            margin-bottom: 30px;
            text-align: center;
        }
        
        .back-btn {
            display: inline-block;
            color: #f59e0b;
            text-decoration: none;
            margin-bottom: 20px;
            font-weight: 600;
        }
        
        .back-btn:hover {
            text-decoration: underline;
        }
        
        .screen {
            display: none;
        }
        
        .screen.active {
            display: block;
        }
        
        .form-group {
            margin-bottom: 25px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            color: #555;
            font-weight: 600;
            font-size: 14px;
        }
        
        input[type="password"], input[type="number"], input[type="text"], select, textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            transition: border 0.3s;
            font-family: inherit;
        }
        
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #f59e0b;
        }
        
        textarea {
            resize: vertical;
            min-height: 80px;
        }
        
        .btn {
            width: 100%;
            padding: 15px;
            background: #f59e0b;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 10px;
        }
        
        .btn:hover {
            background: #d97706;
        }
        
        .btn:disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }
        
        .btn.secondary {
            background: #6b7280;
        }
        
        .btn.secondary:hover {
            background: #4b5563;
        }
        
        .btn.danger {
            background: #ef4444;
        }
        
        .btn.danger:hover {
            background: #dc2626;
        }
        
        .rating-group {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
        }
        
        .rating-group h3 {
            color: #333;
            margin-bottom: 5px;
            font-size: 16px;
        }
        
        .rating-desc {
            color: #666;
            font-size: 12px;
            margin-bottom: 15px;
        }
        
        .rating-buttons {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 8px;
        }
        
        .rating-btn {
            padding: 18px 12px;
            font-size: 18px;
            font-weight: bold;
            border: 2px solid #ddd;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .rating-btn.score-1 {
            border-color: #dc2626;
            color: #dc2626;
        }
        
        .rating-btn.score-1.selected {
            background: #dc2626;
            color: white;
        }
        
        .rating-btn.score-2 {
            border-color: #f97316;
            color: #f97316;
        }
        
        .rating-btn.score-2.selected {
            background: #f97316;
            color: white;
        }
        
        .rating-btn.score-3 {
            border-color: #fbbf24;
            color: #ca8a04;
        }
        
        .rating-btn.score-3.selected {
            background: #fbbf24;
            color: white;
        }
        
        .rating-btn.score-4 {
            border-color: #84cc16;
            color: #4d7c0f;
        }
        
        .rating-btn.score-4.selected {
            background: #84cc16;
            color: white;
        }
        
        .rating-btn.score-5 {
            border-color: #22c55e;
            color: #15803d;
        }
        
        .rating-btn.score-5.selected {
            background: #22c55e;
            color: white;
        }
        
        .current-judge {
            background: #f59e0b;
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            text-align: center;
            margin-bottom: 20px;
            font-weight: bold;
        }
        
        .dish-info {
            background: #fef3c7;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #f59e0b;
        }
        
        .dish-info h3 {
            color: #92400e;
            margin-bottom: 5px;
        }
        
        .dish-info p {
            color: #78350f;
            font-size: 14px;
        }
        
        .error {
            background: #fee2e2;
            border: 2px solid #ef4444;
            color: #991b1b;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .success {
            background: #d1fae5;
            border: 2px solid #10b981;
            color: #065f46;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .progress {
            background: #e5e7eb;
            height: 8px;
            border-radius: 4px;
            margin: 20px 0;
            overflow: hidden;
        }
        
        .progress-bar {
            background: #f59e0b;
            height: 100%;
            transition: width 0.3s;
        }
        
        .emergency {
            margin-top: 30px;
            padding: 15px;
            background: #fee2e2;
            border-radius: 8px;
            text-align: center;
            font-size: 12px;
            color: #991b1b;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 12px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .modal-content h3 {
            margin-bottom: 20px;
            color: #333;
        }
        
        .modal-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        .modal-buttons button {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
        }
        
        .winner-card {
            background: #fef3c7;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 15px;
            border-left: 4px solid #f59e0b;
        }
        
        .winner-card h4 {
            color: #92400e;
            margin-bottom: 10px;
        }
        
        .winner-card .winner-name {
            font-size: 24px;
            font-weight: bold;
            color: #f59e0b;
            margin: 10px 0;
        }
        
        .winner-card .winner-dish {
            color: #78350f;
            font-size: 16px;
        }
    </style>
</head>
<body>
    <div class="container">
        <a href="index.html" class="back-btn">‚Üê Back to Home</a>
        
        <!-- Login Screen -->
        <div id="loginScreen" class="screen active">
            <h1>üë®‚Äç‚öñÔ∏è Judges Panel</h1>
            <div class="form-group">
                <label>Enter Judge Password</label>
                <input type="password" id="judgePassword" placeholder="Enter password">
            </div>
            <button class="btn" onclick="login()">Login</button>
        </div>
        
        <!-- Judge Setup Screen -->
        <div id="setupScreen" class="screen">
            <h1>Setup Judges</h1>
            <p style="color: #666; margin-bottom: 20px;">This is the first time logging in for this year. Please set up the judging panel.</p>
            <div class="form-group">
                <label>How many judges this year?</label>
                <input type="number" id="judgeCount" min="1" max="10" value="4">
            </div>
            <div id="judgeNamesContainer"></div>
            <button class="btn" onclick="saveJudgeSetup()">Save & Continue</button>
        </div>
        
        <!-- Judge Selection Screen -->
        <div id="judgeSelectScreen" class="screen">
            <h1>Select Your Name</h1>
            <div id="judgeButtons"></div>
        </div>
        
        <!-- Dish Selection Screen -->
        <div id="dishSelectScreen" class="screen">
            <div class="current-judge" id="currentJudgeName"></div>
            <h1>Select a Dish to Rate</h1>
            <div class="progress">
                <div class="progress-bar" id="progressBar"></div>
            </div>
            <p style="text-align: center; color: #666; margin-bottom: 20px;" id="progressText">0 / 0 rated</p>
            <div class="form-group">
                <label>Choose Sticker Number</label>
                <select id="stickerSelect">
                    <option value="">Select a sticker number...</option>
                </select>
            </div>
            <button class="btn" onclick="startRating()">Rate This Dish</button>
            <button class="btn secondary" onclick="changeJudge()" style="margin-top: 10px;">Change Judge</button>
            <button class="btn danger" id="completeBtn" onclick="showCompleteModal()" style="margin-top: 20px; display: none;">Complete Scoring for This Year</button>
            <div class="emergency" id="emergencyContact" style="display: none;">
                In case of emergency with this app, please text Br Usman at 305-763-0271
            </div>
        </div>
        
        <!-- Rating Screen -->
        <div id="ratingScreen" class="screen">
            <div class="current-judge" id="ratingJudgeName"></div>
            <div class="dish-info">
                <h3 id="dishName"></h3>
                <p id="dishCategory"></p>
            </div>
            
            <div class="rating-group">
                <h3>Taste & Flavor</h3>
                <div class="rating-desc">Balance and seasoning. Does it taste good? Would you want more?</div>
                <div class="rating-buttons" id="tasteRating"></div>
            </div>
            
            <div class="rating-group">
                <h3>Texture & Doneness</h3>
                <div class="rating-desc">Cooked correctly? Does it feel right for the dish type?</div>
                <div class="rating-buttons" id="textureRating"></div>
            </div>
            
            <div class="rating-group">
                <h3>Intentionality & Thoughtfulness</h3>
                <div class="rating-desc">Did the cook show care or technique? Well-prepared for its style?</div>
                <div class="rating-buttons" id="intentionalityRating"></div>
            </div>
            
            <div class="rating-group">
                <h3>Presentation</h3>
                <div class="rating-desc">How neat and visually appealing? Consider plating and organization.</div>
                <div class="rating-buttons" id="presentationRating"></div>
            </div>
            
            <div class="rating-group">
                <h3>Category Fit</h3>
                <div class="rating-desc">Does it belong in this category?</div>
                <div class="rating-buttons" id="categoryFitRating"></div>
            </div>
            
            <div class="form-group">
                <label>Notes (Optional)</label>
                <textarea id="notes" placeholder="Any additional comments..."></textarea>
            </div>
            
            <button class="btn" id="submitRatingBtn" onclick="submitRating()" disabled>Submit Rating</button>
            <button class="btn secondary" onclick="cancelRating()">Cancel</button>
        </div>
        
        <!-- Results Screen -->
        <div id="resultsScreen" class="screen">
            <h1>üèÜ Competition Results</h1>
            <div id="winnersContainer"></div>
            <button class="btn" onclick="location.href='index.html'">Back to Home</button>
        </div>
    </div>
    
    <!-- Complete Scoring Modal -->
    <div id="completeModal" class="modal">
        <div class="modal-content">
            <h3>Complete Scoring?</h3>
            <p style="margin-bottom: 20px; color: #666;">Are you sure ALL judges have finished rating ALL dishes? This action cannot be undone.</p>
            <div class="form-group">
                <label>Enter Admin Password</label>
                <input type="password" id="completePassword">
            </div>
            <div class="modal-buttons">
                <button class="btn secondary" onclick="closeCompleteModal()">Cancel</button>
                <button class="btn danger" onclick="completeScoring()">Complete & Lock Year</button>
            </div>
        </div>
    </div>
    
    <!-- Tie Breaker Modal -->
    <div id="tieModal" class="modal">
        <div class="modal-content">
            <h3>Tie Detected!</h3>
            <p id="tieMessage" style="margin-bottom: 20px; color: #666;"></p>
            <div id="tieOptions"></div>
        </div>
    </div>

    <script>
        const REPO_OWNER = 'VRICSisters';
        const REPO_NAME = 'tasteofvric';
        const DATA_TOKEN = 'YOUR_TOKEN_HERE'; // Replace with your token
        
        let currentYear = 2026;
        let currentJudge = '';
        let currentJudgeIndex = -1;
        let judgesData = null;
        let entriesData = null;
        let currentSticker = null;
        let ratings = {
            taste: null,
            texture: null,
            intentionality: null,
            presentation: null,
            categoryFit: null
        };
        let ties = {};
        
        async function login() {
            const password = document.getElementById('judgePassword').value;
            
            if (password !== 'ILoveVR!C') {
                alert('Incorrect password');
                return;
            }
            
            try {
                // Load config
                const configRes = await fetch(`https://raw.githubusercontent.com/${REPO_OWNER}/${REPO_NAME}/main/data/config.json?t=${Date.now()}`);
                const config = await configRes.json();
                currentYear = config.currentYear;
                
                // Load judges data
                const judgesRes = await fetch(`https://raw.githubusercontent.com/${REPO_OWNER}/${REPO_NAME}/main/data/judges.json?t=${Date.now()}`);
                judgesData = await judgesRes.json();
                
                // Load entries data
                const entriesRes = await fetch(`https://raw.githubusercontent.com/${REPO_OWNER}/${REPO_NAME}/main/data/entries.json?t=${Date.now()}`);
                entriesData = await entriesRes.json();
                
                // Check if year is completed
                if (judgesData[currentYear]?.completed) {
                    showResults();
                    return;
                }
                
                // Check if judges are set up
                if (!judgesData[currentYear] || judgesData[currentYear].judgeCount === 0) {
                    showScreen('setupScreen');
                    generateJudgeNameInputs(4);
                } else {
                    showScreen('judgeSelectScreen');
                    displayJudgeButtons();
                }
                
            } catch (error) {
                alert('Failed to load data: ' + error.message);
            }
        }
        
        function generateJudgeNameInputs(count) {
            const container = document.getElementById('judgeNamesContainer');
            container.innerHTML = '';
            
            for (let i = 0; i < count; i++) {
                const div = document.createElement('div');
                div.className = 'form-group';
                div.innerHTML = `
                    <label>Judge ${i + 1} Name</label>
                    <input type="text" id="judgeName${i}" placeholder="Enter judge name" required>
                `;
                container.appendChild(div);
            }
        }
        
        document.getElementById('judgeCount')?.addEventListener('change', function() {
            generateJudgeNameInputs(parseInt(this.value));
        });
        
        async function saveJudgeSetup() {
            const count = parseInt(document.getElementById('judgeCount').value);
            const names = [];
            
            for (let i = 0; i < count; i++) {
                const name = document.getElementById(`judgeName${i}`).value.trim();
                if (!name) {
                    alert(`Please enter a name for Judge ${i + 1}`);
                    return;
                }
                names.push(name);
            }
            
            judgesData[currentYear] = {
                judgeNames: names,
                judgeCount: count,
                scores: [],
                completed: false
            };
            
            try {
                await fetch(`https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/dispatches`, {
                    method: 'POST',
                    headers: {
                        'Accept': 'application/vnd.github.v3+json',
                        'Authorization': `token ${DATA_TOKEN}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        event_type: 'update-judges',
                        client_payload: {
                            data: JSON.stringify(judgesData, null, 2)
                        }
                    })
                });
                
                showScreen('judgeSelectScreen');
                displayJudgeButtons();
                
            } catch (error) {
                alert('Failed to save judges: ' + error.message);
            }
        }
        
        function displayJudgeButtons() {
            const container = document.getElementById('judgeButtons');
            container.innerHTML = '';
            
            judgesData[currentYear].judgeNames.forEach((name, index) => {
                const btn = document.createElement('button');
                btn.className = 'btn';
                btn.textContent = name;
                btn.style.marginBottom = '10px';
                btn.onclick = () => selectJudge(name, index);
                container.appendChild(btn);
            });
        }
        
        function selectJudge(name, index) {
            currentJudge = name;
            currentJudgeIndex = index;
            showScreen('dishSelectScreen');
            document.getElementById('currentJudgeName').textContent = name;
            loadDishOptions();
            updateProgress();
            
            // Show complete button and emergency contact only for Judge 1
            if (index === 0) {
                document.getElementById('completeBtn').style.display = 'block';
                document.getElementById('emergencyContact').style.display = 'block';
            } else {
                document.getElementById('completeBtn').style.display = 'none';
                document.getElementById('emergencyContact').style.display = 'none';
            }
        }
        
        function loadDishOptions() {
            const select = document.getElementById('stickerSelect');
            select.innerHTML = '<option value="">Select a sticker number...</option>';
            
            const currentEntries = entriesData[currentYear] || [];
            const currentScores = judgesData[currentYear].scores || [];
            
            // Get dishes already rated by this judge
            const ratedStickers = currentScores
                .filter(s => s.judge === currentJudge)
                .map(s => s.stickerNumber);
            
            currentEntries.forEach(entry => {
                const option = document.createElement('option');
                option.value = entry.stickerNumber;
                
                if (ratedStickers.includes(entry.stickerNumber)) {
                    option.textContent = `${entry.stickerNumber} - ${entry.dish} (Already Rated)`;
                    option.style.color = '#9ca3af';
                } else {
                    option.textContent = `${entry.stickerNumber} - ${entry.dish}`;
                }
                
                select.appendChild(option);
            });
        }
        
        function updateProgress() {
            const currentEntries = entriesData[currentYear] || [];
            const currentScores = judgesData[currentYear].scores || [];
            const ratedCount = currentScores.filter(s => s.judge === currentJudge).length;
            const totalCount = currentEntries.length;
            
            const percentage = totalCount > 0 ? (ratedCount / totalCount) * 100 : 0;
            document.getElementById('progressBar').style.width = percentage + '%';
            document.getElementById('progressText').textContent = `${ratedCount} / ${totalCount} rated`;
        }
        
        function startRating() {
            const sticker = document.getElementById('stickerSelect').value;
            
            if (!sticker) {
                alert('Please select a sticker number');
                return;
            }
            
            currentSticker = sticker;
            const entry = entriesData[currentYear].find(e => e.stickerNumber === sticker);
            
            if (!entry) {
                alert('Entry not found');
                return;
            }
            
            // Load existing rating if editing
            const existingRating = judgesData[currentYear].scores.find(
                s => s.judge === currentJudge && s.stickerNumber === sticker
            );
            
            if (existingRating) {
                ratings = {
                    taste: existingRating.taste,
                    texture: existingRating.texture,
                    intentionality: existingRating.intentionality,
                    presentation: existingRating.presentation,
                    categoryFit: existingRating.categoryFit
                };
                document.getElementById('notes').value = existingRating.notes || '';
            } else {
                ratings = {
                    taste: null,
                    texture: null,
                    intentionality: null,
                    presentation: null,
                    categoryFit: null
                };
                document.getElementById('notes').value = '';
            }
            
            document.getElementById('dishName').textContent = `Sticker #${entry.stickerNumber}: ${entry.dish}`;
            document.getElementById('dishCategory').textContent = `Category: ${entry.category}`;
            document.getElementById('ratingJudgeName').textContent = currentJudge;
            
            showScreen('ratingScreen');
            createRatingButtons();
            updateSubmitButton();
        }
        
        function createRatingButtons() {
            ['taste', 'texture', 'intentionality', 'presentation', 'categoryFit'].forEach(category => {
                const container = document.getElementById(`${category}Rating`);
                container.innerHTML = '';
                
                for (let i = 1; i <= 5; i++) {
                    const btn = document.createElement('button');
                    btn.className = `rating-btn score-${i}`;
                    btn.textContent = i;
                    btn.onclick = () => selectRating(category, i, btn);
                    
                    if (ratings[category] === i) {
                        btn.classList.add('selected');
                    }
                    
                    container.appendChild(btn);
                }
            });
        }
        
        function selectRating(category, value, btn) {
            ratings[category] = value;
            btn.parentElement.querySelectorAll('.rating-btn').forEach(b => {
                b.classList.remove('selected');
            });
            btn.classList.add('selected');
            updateSubmitButton();
        }
        
        function updateSubmitButton() {
            const allRated = ratings.taste && ratings.texture && ratings.intentionality && 
                           ratings.presentation && ratings.categoryFit;
            document.getElementById('submitRatingBtn').disabled = !allRated;
        }
        
        async function submitRating() {
            const notes = document.getElementById('notes').value.trim();
            
            try {
                // Remove existing rating if editing
                judgesData[currentYear].scores = judgesData[currentYear].scores.filter(
                    s => !(s.judge === currentJudge && s.stickerNumber === currentSticker)
                );
                
                // Add new rating
                judgesData[currentYear].scores.push({
                    judge: currentJudge,
                    stickerNumber: currentSticker,
                    taste: ratings.taste,
                    texture: ratings.texture,
                    intentionality: ratings.intentionality,
                    presentation: ratings.presentation,
                    categoryFit: ratings.categoryFit,
                    notes: notes,
                    timestamp: new Date().toISOString()
                });
                
                await fetch(`https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/dispatches`, {
                    method: 'POST',
                    headers: {
                        'Accept': 'application/vnd.github.v3+json',
                        'Authorization': `token ${DATA_TOKEN}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        event_type: 'update-judges',
                        client_payload: {
                            data: JSON.stringify(judgesData, null, 2)
                        }
                    })
                });
                
                showScreen('dishSelectScreen');
                loadDishOptions();
                updateProgress();
                
            } catch (error) {
                alert('Failed to save rating: ' + error.message);
            }
        }
        
        function cancelRating() {
            showScreen('dishSelectScreen');
        }
        
        function changeJudge() {
            currentJudge = '';
            currentJudgeIndex = -1;
            showScreen('judgeSelectScreen');
        }
        
        function showCompleteModal() {
            const currentEntries = entriesData[currentYear] || [];
            const currentScores = judgesData[currentYear].scores || [];
            const judgeCount = judgesData[currentYear].judgeCount;
            
            // Calculate completion percentage
            const totalNeeded = currentEntries.length * judgeCount;
            const currentTotal = currentScores.length;
            const percentage = (currentTotal / totalNeeded) * 100;
            
            if (percentage < 80) {
                alert(`Only ${percentage.toFixed(0)}% of dishes have been rated. Please ensure at least 80% are complete before closing the year.`);
                return;
            }
            
            document.getElementById('completeModal').classList.add('active');
        }
        
        function closeCompleteModal() {
            document.getElementById('completeModal').classList.remove('active');
            document.getElementById('completePassword').value = '';
        }
        
        async function completeScoring() {
            const password = document.getElementById('completePassword').value;
            
            if (password !== 'adminVR!C') {
                alert('Incorrect password');
                return;
            }
            
            try {
                // Calculate winners
                const winners = calculateWinners();
                
                // Check for ties
                ties = {};
                Object.keys(winners).forEach(category => {
                    if (winners[category].tie) {
                        ties[category] = winners[category].dishes;
                    }
                });
                
                if (Object.keys(ties).length > 0) {
                    closeCompleteModal();
                    showTieBreaker();
                    return;
                }
                
                // No ties, finalize
                await finalizeYear(winners);
                
            } catch (error) {
                alert('Failed to complete scoring: ' + error.message);
            }
        }
        
        function calculateWinners() {
            const currentEntries = entriesData[currentYear] || [];
            const currentScores = judgesData[currentYear].scores || [];
            const categories = ['Appetizer', 'Entree', 'Dessert'];
            const winners = {};
            
            categories.forEach(category => {
                const categoryEntries = currentEntries.filter(e => e.category === category);
                const scores = {};
                
                categoryEntries.forEach(entry => {
                    const entryScores = currentScores.filter(s => s.stickerNumber === entry.stickerNumber);
                    if (entryScores.length > 0) {
                        const avgTotal = entryScores.reduce((sum, s) => 
                            sum + s.taste + s.texture + s.intentionality + s.presentation + s.categoryFit, 0
                        ) / entryScores.length;
                        
                        scores[entry.stickerNumber] = {
                            total: avgTotal,
                            dish: entry.dish,
                            name: entry.name
                        };
                    }
                });
                
                // Find highest score
                const sorted = Object.entries(scores).sort((a, b) => b[1].total - a[1].total);
                
                if (sorted.length > 0) {
                    const topScore = sorted[0][1].total;
                    const topDishes = sorted.filter(s => s[1].total === topScore);
                    
                    if (topDishes.length > 1) {
                        winners[category] = {
                            tie: true,
                            dishes: topDishes.map(d => ({
                                sticker: d[0],
                                dish: d[1].dish,
                                name: d[1].name,
                                score: d[1].total
                            }))
                        };
                    } else {
                        winners[category] = {
                            sticker: sorted[0][0],
                            dish: sorted[0][1].dish,
                            name: sorted[0][1].name,
                            score: sorted[0][1].total
                        };
                    }
                }
            });
            
            return winners;
        }
        
        function showTieBreaker() {
            const modal = document.getElementById('tieModal');
            const message = document.getElementById('tieMessage');
            const options = document.getElementById('tieOptions');
            
            const categories = Object.keys(ties);
            const firstCategory = categories[0];
            const tiedDishes = ties[firstCategory];
            
            message.textContent = `There is a tie in the ${firstCategory} category. Vote in person, then select the winner:`;
            
            options.innerHTML = '';
            tiedDishes.forEach(dish => {
                const btn = document.createElement('button');
                btn.className = 'btn';
                btn.style.marginBottom = '10px';
                btn.textContent = `Sticker #${dish.sticker} - ${dish.dish} (${dish.score.toFixed(2)})`;
                btn.onclick = () => selectTieWinner(firstCategory, dish.sticker);
                options.appendChild(btn);
            });
            
            modal.classList.add('active');
        }
        
        async function selectTieWinner(category, sticker) {
            delete ties[category];
            
            if (Object.keys(ties).length > 0) {
                showTieBreaker();
            } else {
                document.getElementById('tieModal').classList.remove('active');
                
                // Recalculate winners with tie-breaker selections
                const winners = calculateWinners();
                // Apply manual tie selections here if needed
                
                await finalizeYear(winners);
            }
        }
        
        async function finalizeYear(winners) {
            judgesData[currentYear].completed = true;
            judgesData[currentYear].winners = {};
            
            Object.keys(winners).forEach(category => {
                if (!winners[category].tie) {
                    judgesData[currentYear].winners[category] = winners[category].sticker;
                }
            });
            
            // Update judges data
            await fetch(`https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/dispatches`, {
                method: 'POST',
                headers: {
                    'Accept': 'application/vnd.github.v3+json',
                    'Authorization': `token ${DATA_TOKEN}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    event_type: 'update-judges',
                    client_payload: {
                        data: JSON.stringify(judgesData, null, 2)
                    }
                })
            });
            
            // Update config to mark year as completed
            const configRes = await fetch(`https://raw.githubusercontent.com/${REPO_OWNER}/${REPO_NAME}/main/data/config.json?t=${Date.now()}`);
            const config = await configRes.json();
            config.yearCompleted[currentYear] = true;
            
            await fetch(`https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/dispatches`, {
                method: 'POST',
                headers: {
                    'Accept': 'application/vnd.github.v3+json',
                    'Authorization': `token ${DATA_TOKEN}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    event_type: 'update-config',
                    client_payload: {
                        data: JSON.stringify(config, null, 2)
                    }
                })
            });
            
            closeCompleteModal();
            showResults();
        }
        
        function showResults() {
            const container = document.getElementById('winnersContainer');
            container.innerHTML = '';
            
            const winners = judgesData[currentYear].winners || {};
            const categories = ['Appetizer', 'Entree', 'Dessert'];
            
            categories.forEach(category => {
                const winnerSticker = winners[category];
                if (winnerSticker) {
                    const entry = entriesData[currentYear].find(e => e.stickerNumber === winnerSticker);
                    if (entry) {
                        const card = document.createElement('div');
                        card.className = 'winner-card';
                        card.innerHTML = `
                            <h4>${category} Winner</h4>
                            <div class="winner-name">${entry.name}</div>
                            <div class="winner-dish">${entry.dish}</div>
                            <p style="color: #78350f; margin-top: 10px;">Sticker #${entry.stickerNumber}</p>
                        `;
                        container.appendChild(card);
                    }
                }
            });
            
            showScreen('resultsScreen');
        }
        
        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(screenId).classList.add('active');
        }
    </script>
</body>
</html>
