<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Taste of VRIC</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .login-container {
            max-width: 400px;
            margin: 100px auto;
            background: white;
            border-radius: 12px;
            padding: 40px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        h1 {
            color: #333;
            margin-bottom: 30px;
        }
        
        .controls {
            margin-bottom: 20px;
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        button {
            padding: 12px 24px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
        }
        
        button:hover {
            background: #5568d3;
        }
        
        .export-btn {
            background: #10b981;
        }
        
        .export-btn:hover {
            background: #059669;
        }
        
        .delete-btn {
            background: #ef4444;
            padding: 6px 12px;
            font-size: 12px;
        }
        
        .delete-btn:hover {
            background: #dc2626;
        }
        
        .inspect-btn {
            background: #667eea;
            padding: 6px 12px;
            font-size: 12px;
            margin-right: 5px;
        }
        
        .inspect-btn:hover {
            background: #5568d3;
        }
        
        .approve-btn {
            background: #10b981;
            padding: 6px 12px;
            font-size: 12px;
        }
        
        .approve-btn:hover {
            background: #059669;
        }
        
        .reject-btn {
            background: #ef4444;
            padding: 6px 12px;
            font-size: 12px;
        }
        
        .reject-btn:hover {
            background: #dc2626;
        }
        
        select, input[type="password"], input[type="text"], input[type="number"], textarea {
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            background: white;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 40px;
        }
        
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e5e5e5;
        }
        
        th {
            background: #f8f9fa;
            font-weight: 600;
            color: #555;
            position: sticky;
            top: 0;
            cursor: pointer;
        }
        
        th:hover {
            background: #e9ecef;
        }
        
        .duplicate-warning {
            background: #fef3c7;
            border-left: 4px solid #f59e0b;
        }
        
        .wrong-category {
            background: #fee2e2;
            border-left: 4px solid #ef4444;
        }
        
        .averages {
            background: #f0f4ff;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 30px;
        }
        
        .averages h2 {
            color: #333;
            margin-bottom: 15px;
            font-size: 20px;
        }
        
        .category-section {
            margin-bottom: 40px;
        }
        
        .category-section h3 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 18px;
            padding-bottom: 10px;
            border-bottom: 2px solid #667eea;
        }
        
        .avg-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .avg-card {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }
        
        .avg-card h4 {
            font-size: 14px;
            color: #666;
            margin-bottom: 5px;
        }
        
        .avg-card .value {
            font-size: 24px;
            font-weight: bold;
            color: #333;
        }
        
        .avg-card .rank {
            display: inline-block;
            background: #667eea;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
            margin-right: 8px;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            align-items: center;
            justify-content: center;
            z-index: 1000;
            overflow-y: auto;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 12px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            margin: 20px;
        }
        
        .modal-content h3 {
            margin-bottom: 20px;
            color: #333;
        }
        
        .modal-content p {
            margin-bottom: 20px;
            color: #666;
        }
        
        .modal-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        .modal-buttons button {
            flex: 1;
            padding: 12px;
        }
        
        .cancel-btn {
            background: #6b7280;
        }
        
        .cancel-btn:hover {
            background: #4b5563;
        }
        
        .recipe-detail {
            margin-bottom: 20px;
        }
        
        .recipe-detail h4 {
            color: #667eea;
            margin-bottom: 8px;
            font-size: 14px;
        }
        
        .recipe-detail p, .recipe-detail ul {
            color: #333;
            line-height: 1.6;
        }
        
        .recipe-detail ul {
            list-style-position: inside;
        }
        
        .recipe-photo-large {
            width: 100%;
            max-height: 300px;
            object-fit: cover;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .alert-box {
            border: 2px solid;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .alert-box h3 {
            margin-bottom: 10px;
            font-size: 16px;
        }
        
        .alert-box ul {
            list-style: none;
        }
        
        .alert-box li {
            margin: 5px 0;
        }
        
        .alert-warning {
            background: #fef3c7;
            border-color: #f59e0b;
            color: #92400e;
        }
        
        .alert-error {
            background: #fee2e2;
            border-color: #ef4444;
            color: #991b1b;
        }
        
        .pending-badge {
            background: #f59e0b;
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
            margin-left: 10px;
        }
        
        .recipe-preview {
            max-width: 150px;
            max-height: 150px;
            border-radius: 8px;
            cursor: pointer;
        }
        
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #e5e7eb;
        }
        
        .tab {
            padding: 12px 24px;
            background: none;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-weight: 600;
            color: #6b7280;
        }
        
        .tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 5px;
            color: #555;
            font-size: 14px;
        }
        
        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .form-group textarea {
            min-height: 80px;
            font-family: monospace;
        }
        
        .duration-group {
            display: grid;
            grid-template-columns: 60% 38%;
            gap: 2%;
        }
        
        .search-filter {
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        
        .search-filter input {
            width: 100%;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 14px;
        }
        
        @media (max-width: 768px) {
            .modal-content {
                padding: 20px;
                max-width: 95%;
            }
            
            .duration-group {
                grid-template-columns: 1fr;
                gap: 10px;
            }
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div id="loginScreen" class="login-container">
        <h1>üîê Admin Login</h1>
        <div style="margin-bottom: 20px;">
            <input type="password" id="adminPassword" placeholder="Enter admin password" style="width: 100%; margin-bottom: 15px;">
        </div>
        <button onclick="adminLogin()" style="width: 100%;">Login</button>
    </div>
    
    <!-- Main Dashboard -->
    <div id="dashboard" style="display: none;">
        <div class="container">
            <h1>üìä Admin Dashboard - <span id="yearDisplay">2026</span></h1>
            
            <div class="tabs">
                <button class="tab active" onclick="showTab('competition')">Competition Data</button>
                <button class="tab" onclick="showTab('cookbook')">Cookbook Approval <span id="pendingCount" class="pending-badge" style="display: none;">0</span></button>
                <button class="tab" onclick="showTab('manage-cookbook')">Manage Cookbook</button>
            </div>
            
            <!-- Competition Tab -->
            <div id="competitionTab" class="tab-content active">
                <div class="controls">
                    <button onclick="loadData()">Refresh Data</button>
                    <button class="export-btn" onclick="exportCSV()">Export as CSV</button>
                    <select id="categoryFilter" onchange="filterByCategory()">
                        <option value="all">All Categories</option>
                        <option value="Appetizer">Appetizer</option>
                        <option value="Entree">Entree</option>
                        <option value="Dessert">Dessert</option>
                    </select>
                    <select id="yearSelect" onchange="changeYear()">
                    </select>
                </div>
                
                <div id="wrongCategoryAlert" class="alert-box alert-error" style="display: none;">
                    <h3>‚ùå Wrong Category Detected</h3>
                    <ul id="wrongCategoryList"></ul>
                </div>
                
                <div id="duplicatesAlert" class="alert-box alert-warning" style="display: none;">
                    <h3>‚ö†Ô∏è Duplicate Entries Detected</h3>
                    <ul id="duplicatesList"></ul>
                </div>
                
                <div id="loading" class="loading">Loading data...</div>
                
                <div id="content" style="display: none;">
                    <div class="averages">
                        <h2>Rankings by Category</h2>
                        <div id="categoriesContainer"></div>
                    </div>
                    
                    <h2>All Ratings (Raw Data)</h2>
                    <div style="overflow-x: auto;">
                        <table id="ratingsTable">
                            <thead>
                                <tr>
                                    <th>Timestamp</th>
                                    <th>Judge</th>
                                    <th>Sticker</th>
                                    <th>Category</th>
                                    <th>Taste</th>
                                    <th>Texture</th>
                                    <th>Intentionality</th>
                                    <th>Presentation</th>
                                    <th>Category Fit</th>
                                    <th>Total</th>
                                    <th>Notes</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="ratingsBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- Cookbook Tab -->
            <div id="cookbookTab" class="tab-content">
                <div id="cookbookLoading" class="loading">Loading cookbook submissions...</div>
                
                <div id="cookbookContent" style="display: none;">
                    <h2>Pending Approvals</h2>
                    <div id="pendingRecipes"></div>
                    
                    <h2 style="margin-top: 40px;">Approved Recipes</h2>
                    <div id="approvedRecipes"></div>
                </div>
            </div>
            
            <!-- Manage Cookbook Tab -->
            <div id="manage-cookbookTab" class="tab-content">
                <div id="manageLoading" class="loading">Loading cookbook...</div>
                
                <div id="manageContent" style="display: none;">
                    <h2>Manage Approved Recipes</h2>
                    
                    <div class="search-filter">
                        <input type="text" id="recipeSearch" placeholder="üîç Search by dish name, country, or category..." onkeyup="filterRecipes()">
                    </div>
                    
                    <div style="overflow-x: auto;">
                        <table id="manageTable">
                            <thead>
                                <tr>
                                    <th onclick="sortTable('dishName')">Dish Name ‚Üï</th>
                                    <th onclick="sortTable('category')">Category ‚Üï</th>
                                    <th onclick="sortTable('country')">Country ‚Üï</th>
                                    <th onclick="sortTable('year')">Year ‚Üï</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="manageTableBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Delete Confirmation Modal -->
    <div id="deleteModal" class="modal">
        <div class="modal-content">
            <h3>Delete Rating?</h3>
            <p id="deleteDetails"></p>
            <div class="modal-buttons">
                <button class="cancel-btn" onclick="closeDeleteModal()">Cancel</button>
                <button class="delete-btn" onclick="confirmDelete()">Delete</button>
            </div>
        </div>
    </div>
    
    <!-- Inspect Recipe Modal -->
    <div id="inspectModal" class="modal">
        <div class="modal-content">
            <h3 id="inspectTitle"></h3>
            <div id="inspectContent"></div>
            <div class="modal-buttons">
                <button class="approve-btn" onclick="approveFromInspect()">Approve</button>
                <button class="reject-btn" onclick="rejectFromInspect()">Reject</button>
                <button class="cancel-btn" onclick="closeInspectModal()">Close</button>
            </div>
        </div>
    </div>
    
    <!-- Edit Recipe Modal -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <h3>Edit Recipe</h3>
            <div id="editForm"></div>
            <div class="modal-buttons">
                <button class="approve-btn" onclick="saveEditedRecipe()">Save Changes</button>
                <button class="delete-btn" onclick="deleteEditedRecipe()">Delete Recipe</button>
                <button class="cancel-btn" onclick="closeEditModal()">Cancel</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
        import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBLuoW3l8TM9s-C47uNF0gxDBmzYfGq_Z0",
            authDomain: "tasteofvric-97d8b.firebaseapp.com",
            projectId: "tasteofvric-97d8b",
            storageBucket: "tasteofvric-97d8b.firebasestorage.app",
            messagingSenderId: "538483030204",
            appId: "1:538483030204:web:5a0414d9bf35bcf2e238b9"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        window.db = db;
        window.doc = doc;
        window.getDoc = getDoc;
        window.setDoc = setDoc;
    </script>

    <script>
        const IMGBB_API_KEY = 'ecda6fd2f3949077b14a84c600294ff7';
        
        const CORRECT_CATEGORIES = {
            '2': 'Appetizer',
            '1': 'Dessert',
            '3': 'Dessert',
            '4': 'Appetizer',
            '5': 'Entree',
            '7': 'Dessert',
            '9': 'Entree',
            '10': 'Appetizer',
            '6': 'Entree',
            '11': 'Entree',
            '12': 'Dessert',
            '8': 'Appetizer'
        };
        
        let currentYear = 2026;
        let allRatings = [];
        let allEntries = [];
        let allJudges = {};
        let cookbook = {};
        let deleteIndex = -1;
        let duplicates = [];
        let wrongCategories = [];
        let autoRefreshInterval = null;
        let currentInspectIndex = -1;
        let currentEditIndex = -1;
        let filteredRecipes = [];
        let sortColumn = '';
        let sortAscending = true;
        
        // Enter key support for login
        document.getElementById('adminPassword')?.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                adminLogin();
            }
        });
        
        function adminLogin() {
            const password = document.getElementById('adminPassword').value;
            
            if (password !== 'adminVR!C') {
                alert('Incorrect password');
                return;
            }
            
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('dashboard').style.display = 'block';
            
            loadYearOptions();
            loadData();
            loadCookbook();
            
            autoRefreshInterval = setInterval(() => {
                loadData();
                loadCookbook();
            }, 10000);
        }
        
        async function loadYearOptions() {
            try {
                const configDoc = await window.getDoc(window.doc(window.db, 'config', 'settings'));
                
                if (configDoc.exists()) {
                    const config = configDoc.data();
                    const years = Object.keys(config.yearCompleted || {}).sort().reverse();
                    
                    const select = document.getElementById('yearSelect');
                    select.innerHTML = '';
                    
                    years.forEach(year => {
                        const option = document.createElement('option');
                        option.value = year;
                        option.textContent = year;
                        if (parseInt(year) === currentYear) {
                            option.selected = true;
                        }
                        select.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Failed to load years:', error);
            }
        }
        
        function changeYear() {
            currentYear = parseInt(document.getElementById('yearSelect').value);
            document.getElementById('yearDisplay').textContent = currentYear;
            loadData();
        }
        
        async function loadData() {
            document.getElementById('loading').style.display = 'block';
            document.getElementById('content').style.display = 'none';
            
            try {
                const [entriesDoc, judgesDoc] = await Promise.all([
                    window.getDoc(window.doc(window.db, 'entries', currentYear.toString())),
                    window.getDoc(window.doc(window.db, 'judges', currentYear.toString()))
                ]);
                
                allEntries = entriesDoc.exists() ? (entriesDoc.data().entries || []) : [];
                allJudges = judgesDoc.exists() ? judgesDoc.data() : { judges: [], scores: [] };
                allRatings = allJudges.scores || [];
                
                detectDuplicates();
                detectWrongCategories();
                displayRawData();
                displayCategoryRankings();
                
                document.getElementById('loading').style.display = 'none';
                document.getElementById('content').style.display = 'block';
            } catch (error) {
                console.error('Failed to load data:', error);
                alert('Failed to load data: ' + error.message);
            }
        }
        
        function detectWrongCategories() {
            wrongCategories = [];
            
            allEntries.forEach((entry, index) => {
                const correctCategory = CORRECT_CATEGORIES[entry.stickerNumber];
                if (correctCategory && entry.category !== correctCategory) {
                    wrongCategories.push({
                        index: index,
                        name: entry.name,
                        sticker: entry.stickerNumber,
                        currentCategory: entry.category,
                        correctCategory: correctCategory
                    });
                }
            });
            
            const alert = document.getElementById('wrongCategoryAlert');
            const list = document.getElementById('wrongCategoryList');
            
            if (wrongCategories.length > 0) {
                list.innerHTML = wrongCategories.map(wrong => 
                    `<li>Sticker #${wrong.sticker}: Should be <strong>${wrong.correctCategory}</strong>, not ${wrong.currentCategory}</li>`
                ).join('');
                alert.style.display = 'block';
            } else {
                alert.style.display = 'none';
            }
        }
        
        function detectDuplicates() {
            duplicates = [];
            const seen = {};
            
            allRatings.forEach((rating, index) => {
                const key = `${rating.judge}-${rating.stickerNumber}`;
                if (seen[key]) {
                    duplicates.push({
                        judge: rating.judge,
                        sticker: rating.stickerNumber,
                        indices: [seen[key], index]
                    });
                } else {
                    seen[key] = index;
                }
            });
            
            const alert = document.getElementById('duplicatesAlert');
            const list = document.getElementById('duplicatesList');
            
            if (duplicates.length > 0) {
                list.innerHTML = duplicates.map(dup => 
                    `<li>${dup.judge} rated Sticker #${dup.sticker} multiple times</li>`
                ).join('');
                alert.style.display = 'block';
            } else {
                alert.style.display = 'none';
            }
        }
        
        function isDuplicate(rating) {
            const key = `${rating.judge}-${rating.stickerNumber}`;
            return allRatings.filter(r => `${r.judge}-${r.stickerNumber}` === key).length > 1;
        }
        
        function isWrongCategory(entry) {
            const correctCategory = CORRECT_CATEGORIES[entry.stickerNumber];
            return correctCategory && entry.category !== correctCategory;
        }
        
        function displayRawData() {
            const tbody = document.getElementById('ratingsBody');
            tbody.innerHTML = '';
            
            const filter = document.getElementById('categoryFilter').value;
            
            let filteredRatings = allRatings;
            if (filter !== 'all') {
                const filteredStickers = allEntries
                    .filter(e => e.category === filter)
                    .map(e => e.stickerNumber);
                filteredRatings = allRatings.filter(r => filteredStickers.includes(r.stickerNumber));
            }
            
            filteredRatings.forEach((rating, index) => {
                const entry = allEntries.find(e => e.stickerNumber === rating.stickerNumber);
                if (!entry) return;
                
                const total = rating.taste + rating.texture + rating.intentionality + 
                            rating.presentation + rating.categoryFit;
                
                const actualIndex = allRatings.indexOf(rating);
                const hasDuplicate = isDuplicate(rating);
                const hasWrongCategory = isWrongCategory(entry);
                const correctCategory = CORRECT_CATEGORIES[entry.stickerNumber];
                
                const row = document.createElement('tr');
                if (hasWrongCategory) {
                    row.className = 'wrong-category';
                } else if (hasDuplicate) {
                    row.className = 'duplicate-warning';
                }
                
                row.innerHTML = `
                    <td>${new Date(rating.timestamp).toLocaleString()}</td>
                    <td>${rating.judge}</td>
                    <td>${rating.stickerNumber}</td>
                    <td>
                        ${entry.category}
                        ${hasWrongCategory ? `<br><small style="color: #ef4444;">Should be: ${correctCategory}</small>` : ''}
                    </td>
                    <td>${rating.taste}</td>
                    <td>${rating.texture}</td>
                    <td>${rating.intentionality}</td>
                    <td>${rating.presentation}</td>
                    <td>${rating.categoryFit}</td>
                    <td><strong>${total}</strong></td>
                    <td>${rating.notes || '-'}</td>
                    <td>
                        <button class="delete-btn" onclick="showDeleteModal(${actualIndex})">Delete</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }
        
        function displayCategoryRankings() {
            const container = document.getElementById('categoriesContainer');
            container.innerHTML = '';
            
            const byCategory = {
                'Appetizer': {},
                'Entree': {},
                'Dessert': {}
            };
            
            allRatings.forEach(rating => {
                const entry = allEntries.find(e => e.stickerNumber === rating.stickerNumber);
                if (!entry) return;
                
                const cat = entry.category;
                const sticker = entry.stickerNumber;
                
                if (!byCategory[cat]) byCategory[cat] = {};
                if (!byCategory[cat][sticker]) byCategory[cat][sticker] = [];
                byCategory[cat][sticker].push(rating);
            });
            
            ['Appetizer', 'Entree', 'Dessert'].forEach(category => {
                if (!byCategory[category] || Object.keys(byCategory[category]).length === 0) return;
                
                const section = document.createElement('div');
                section.className = 'category-section';
                
                const title = document.createElement('h3');
                title.textContent = category;
                section.appendChild(title);
                
                const grid = document.createElement('div');
                grid.className = 'avg-grid';
                
                const dishes = [];
                Object.keys(byCategory[category]).forEach(sticker => {
                    const ratings = byCategory[category][sticker];
                    const count = ratings.length;
                    
                    const avgTotal = ratings.reduce((sum, r) => 
                        sum + r.taste + r.texture + r.intentionality + r.presentation + r.categoryFit, 0) / count;
                    
                    const entry = allEntries.find(e => e.stickerNumber === sticker);
                    
                    dishes.push({
                        sticker,
                        avgTotal,
                        count,
                        dish: entry?.dish || 'Unknown',
                        name: entry?.name || 'Unknown',
                        avgTaste: (ratings.reduce((sum, r) => sum + r.taste, 0) / count).toFixed(2),
                        avgTexture: (ratings.reduce((sum, r) => sum + r.texture, 0) / count).toFixed(2),
                        avgIntentionality: (ratings.reduce((sum, r) => sum + r.intentionality, 0) / count).toFixed(2),
                        avgPresentation: (ratings.reduce((sum, r) => sum + r.presentation, 0) / count).toFixed(2),
                        avgCategoryFit: (ratings.reduce((sum, r) => sum + r.categoryFit, 0) / count).toFixed(2)
                    });
                });
                
                dishes.sort((a, b) => {
                    if (b.avgTotal !== a.avgTotal) return b.avgTotal - a.avgTotal;
                    return parseFloat(b.avgTaste) - parseFloat(a.avgTaste);
                });
                
                dishes.forEach((dish, index) => {
                    const card = document.createElement('div');
                    card.className = 'avg-card';
                    card.innerHTML = `
                        <h4><span class="rank">#${index + 1}</span>Sticker #${dish.sticker}</h4>
                        <div class="value">${dish.avgTotal.toFixed(2)} / 25</div>
                        <div style="font-size: 14px; font-weight: 600; color: #667eea; margin: 8px 0;">${dish.dish}</div>
                        <div style="font-size: 12px; color: #666; margin-bottom: 8px;">${dish.name}</div>
                        <div style="font-size: 12px; color: #666;">
                            Taste: ${dish.avgTaste} | Texture: ${dish.avgTexture}<br>
                            Intent: ${dish.avgIntentionality} | Present: ${dish.avgPresentation}<br>
                            Category: ${dish.avgCategoryFit}<br>
                            <strong>${dish.count} judge${dish.count > 1 ? 's' : ''}</strong>
                        </div>
                    `;
                    grid.appendChild(card);
                });
                
                section.appendChild(grid);
                container.appendChild(section);
            });
        }
        
        function filterByCategory() {
            displayRawData();
        }
        
        function showDeleteModal(index) {
            deleteIndex = index;
            const rating = allRatings[index];
            const entry = allEntries.find(e => e.stickerNumber === rating.stickerNumber);
            const total = rating.taste + rating.texture + rating.intentionality + 
                        rating.presentation + rating.categoryFit;
            
            document.getElementById('deleteDetails').textContent = 
                `Delete rating from ${rating.judge} for Sticker #${rating.stickerNumber} (${entry?.dish || 'Unknown'}) - Total: ${total}/25?`;
            document.getElementById('deleteModal').classList.add('active');
        }
        
        function closeDeleteModal() {
            document.getElementById('deleteModal').classList.remove('active');
            deleteIndex = -1;
        }
        
        async function confirmDelete() {
            if (deleteIndex === -1) return;
            
            try {
                allRatings.splice(deleteIndex, 1);
                allJudges.scores = allRatings;
                
                await window.setDoc(window.doc(window.db, 'judges', currentYear.toString()), allJudges);
                
                closeDeleteModal();
                setTimeout(() => loadData(), 1000);
                
            } catch (error) {
                alert('Failed to delete: ' + error.message);
                closeDeleteModal();
            }
        }
        
        function exportCSV() {
            let csv = 'Timestamp,Judge,Sticker Number,Category,Dish,Name,Taste,Texture,Intentionality,Presentation,Category Fit,Total,Notes\n';
            
            allRatings.forEach(rating => {
                const entry = allEntries.find(e => e.stickerNumber === rating.stickerNumber);
                const total = rating.taste + rating.texture + rating.intentionality + 
                            rating.presentation + rating.categoryFit;
                const notes = (rating.notes || '').replace(/"/g, '""');
                
                csv += `"${rating.timestamp}","${rating.judge}","${rating.stickerNumber}","${entry?.category || ''}","${entry?.dish || ''}","${entry?.name || ''}",${rating.taste},${rating.texture},${rating.intentionality},${rating.presentation},${rating.categoryFit},${total},"${notes}"\n`;
            });
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `vric-ratings-${currentYear}-${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
        }
        
        async function loadCookbook() {
            document.getElementById('cookbookLoading').style.display = 'block';
            document.getElementById('cookbookContent').style.display = 'none';
            
            try {
                const cookbookDoc = await window.getDoc(window.doc(window.db, 'cookbook', 'data'));
                
                if (cookbookDoc.exists()) {
                    cookbook = cookbookDoc.data();
                } else {
                    cookbook = { approved: [], pending: [] };
                }
                
                displayPendingRecipes();
                displayApprovedRecipes();
                
                const pendingCount = cookbook.pending?.length || 0;
                const badge = document.getElementById('pendingCount');
                if (pendingCount > 0) {
                    badge.textContent = pendingCount;
                    badge.style.display = 'inline-block';
                } else {
                    badge.style.display = 'none';
                }
                
                document.getElementById('cookbookLoading').style.display = 'none';
                document.getElementById('cookbookContent').style.display = 'block';
            } catch (error) {
                console.error('Failed to load cookbook:', error);
            }
        }
        
        function displayPendingRecipes() {
            const container = document.getElementById('pendingRecipes');
            container.innerHTML = '';
            
            if (!cookbook.pending || cookbook.pending.length === 0) {
                container.innerHTML = '<p style="color: #666; padding: 20px;">No pending recipes</p>';
                return;
            }
            
            cookbook.pending.forEach((recipe, index) => {
                const card = document.createElement('div');
                card.style.cssText = 'background: #fef3c7; padding: 20px; border-radius: 12px; margin-bottom: 15px; border-left: 4px solid #f59e0b;';
                card.innerHTML = `
                    <h3 style="color: #92400e; margin-bottom: 10px;">${recipe.dishName}</h3>
                    <p style="color: #78350f; margin-bottom: 5px;"><strong>By:</strong> ${recipe.name}</p>
                    <p style="color: #78350f; margin-bottom: 5px;"><strong>Category:</strong> ${recipe.category}</p>
                    <p style="color: #78350f; margin-bottom: 5px;"><strong>Country:</strong> ${recipe.country}</p>
                    ${recipe.photo ? `<img src="${recipe.photo}" class="recipe-preview" style="margin: 10px 0;">` : ''}
                    <div style="margin-top: 15px;">
                        <button class="inspect-btn" onclick="inspectRecipe(${index})">Inspect</button>
                        <button class="approve-btn" onclick="approveRecipe(${index})">Approve</button>
                        <button class="reject-btn" onclick="rejectRecipe(${index})">Reject</button>
                    </div>
                `;
                container.appendChild(card);
            });
        }
        
        function displayApprovedRecipes() {
            const container = document.getElementById('approvedRecipes');
            container.innerHTML = '';
            
            if (!cookbook.approved || cookbook.approved.length === 0) {
                container.innerHTML = '<p style="color: #666; padding: 20px;">No approved recipes yet</p>';
                return;
            }
            
            cookbook.approved.forEach(recipe => {
                const card = document.createElement('div');
                card.style.cssText = 'background: #f0f4ff; padding: 20px; border-radius: 12px; margin-bottom: 15px; border-left: 4px solid #667eea;';
                card.innerHTML = `
                    <h3 style="color: #333; margin-bottom: 10px;">${recipe.dishName}</h3>
                    <p style="color: #666; margin-bottom: 5px;"><strong>By:</strong> ${recipe.firstName} (${recipe.year})</p>
                    <p style="color: #666; margin-bottom: 5px;"><strong>Category:</strong> ${recipe.category}</p>
                    ${recipe.photo ? `<img src="${recipe.photo}" class="recipe-preview" style="margin: 10px 0;">` : ''}
                `;
                container.appendChild(card);
            });
        }
        
        function inspectRecipe(index) {
            currentInspectIndex = index;
            const recipe = cookbook.pending[index];
            
            document.getElementById('inspectTitle').textContent = recipe.dishName;
            
            let content = '';
            
            if (recipe.photo) {
                content += `<img src="${recipe.photo}" class="recipe-photo-large">`;
            }
            
            content += `
                <div class="recipe-detail">
                    <h4>Submitted By</h4>
                    <p>${recipe.name} (${recipe.phone})</p>
                </div>
                
                <div class="recipe-detail">
                    <h4>Category & Origin</h4>
                    <p>${recipe.category} from ${recipe.country}</p>
                </div>
                
                <div class="recipe-detail">
                    <h4>Time</h4>
                    <p>Prep: ${recipe.prepTime} | Cook: ${recipe.cookTime}</p>
                </div>
                
                <div class="recipe-detail">
                    <h4>Ingredients</h4>
                    <ul>
                        ${recipe.ingredients.split('\n').filter(i => i.trim()).map(i => `<li>${i.trim()}</li>`).join('')}
                    </ul>
                </div>
                
                <div class="recipe-detail">
                    <h4>Instructions</h4>
                    <p style="white-space: pre-line;">${recipe.instructions}</p>
                </div>
            `;
            
            if (recipe.notes) {
                content += `
                    <div class="recipe-detail">
                        <h4>Notes</h4>
                        <p>${recipe.notes}</p>
                    </div>
                `;
            }
            
            document.getElementById('inspectContent').innerHTML = content;
            document.getElementById('inspectModal').classList.add('active');
        }
        
        function closeInspectModal() {
            document.getElementById('inspectModal').classList.remove('active');
            currentInspectIndex = -1;
        }
        
        async function approveFromInspect() {
            if (currentInspectIndex === -1) return;
            await approveRecipe(currentInspectIndex);
            closeInspectModal();
        }
        
        async function rejectFromInspect() {
            if (currentInspectIndex === -1) return;
            await rejectRecipe(currentInspectIndex);
            closeInspectModal();
        }
        
        async function approveRecipe(index) {
            try {
                const recipe = cookbook.pending[index];
                recipe.approved = true;
                
                if (!cookbook.approved) cookbook.approved = [];
                cookbook.approved.push(recipe);
                cookbook.pending.splice(index, 1);
                
                await window.setDoc(window.doc(window.db, 'cookbook', 'data'), cookbook);
                
                setTimeout(() => loadCookbook(), 1000);
                
            } catch (error) {
                alert('Failed to approve recipe: ' + error.message);
            }
        }
        
        async function rejectRecipe(index) {
            if (!confirm('Are you sure you want to reject this recipe? This cannot be undone.')) {
                return;
            }
            
            try {
                cookbook.pending.splice(index, 1);
                
                await window.setDoc(window.doc(window.db, 'cookbook', 'data'), cookbook);
                
                setTimeout(() => loadCookbook(), 1000);
                
            } catch (error) {
                alert('Failed to reject recipe: ' + error.message);
            }
        }
        
        async function loadManageCookbook() {
            document.getElementById('manageLoading').style.display = 'block';
            document.getElementById('manageContent').style.display = 'none';
            
            try {
                const cookbookDoc = await window.getDoc(window.doc(window.db, 'cookbook', 'data'));
                
                if (cookbookDoc.exists()) {
                    cookbook = cookbookDoc.data();
                } else {
                    cookbook = { approved: [], pending: [] };
                }
                
                filteredRecipes = [...(cookbook.approved || [])];
                displayManageTable();
                
                document.getElementById('manageLoading').style.display = 'none';
                document.getElementById('manageContent').style.display = 'block';
            } catch (error) {
                console.error('Failed to load cookbook:', error);
            }
        }
        
        function displayManageTable() {
            const tbody = document.getElementById('manageTableBody');
            tbody.innerHTML = '';
            
            if (filteredRecipes.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: #666; padding: 40px;">No recipes found</td></tr>';
                return;
            }
            
            filteredRecipes.forEach((recipe, index) => {
                const actualIndex = cookbook.approved.indexOf(recipe);
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${recipe.dishName}</td>
                    <td>${recipe.category}</td>
                    <td>${recipe.country}</td>
                    <td>${recipe.year}</td>
                    <td>
                        <button class="inspect-btn" onclick="editRecipe(${actualIndex})">Edit</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }
        
        function filterRecipes() {
            const search = document.getElementById('recipeSearch').value.toLowerCase();
            
            if (!search) {
                filteredRecipes = [...(cookbook.approved || [])];
            } else {
                filteredRecipes = (cookbook.approved || []).filter(recipe => {
                    return recipe.dishName.toLowerCase().includes(search) ||
                           recipe.country.toLowerCase().includes(search) ||
                           recipe.category.toLowerCase().includes(search);
                });
            }
            
            displayManageTable();
        }
        
        function sortTable(column) {
            if (sortColumn === column) {
                sortAscending = !sortAscending;
            } else {
                sortColumn = column;
                sortAscending = true;
            }
            
            filteredRecipes.sort((a, b) => {
                let valA = a[column];
                let valB = b[column];
                
                if (typeof valA === 'string') {
                    valA = valA.toLowerCase();
                    valB = valB.toLowerCase();
                }
                
                if (valA < valB) return sortAscending ? -1 : 1;
                if (valA > valB) return sortAscending ? 1 : -1;
                return 0;
            });
            
            displayManageTable();
        }
        
        function editRecipe(index) {
            currentEditIndex = index;
            const recipe = cookbook.approved[index];
            
            // Parse duration
            let prepNum = 0, prepUnit = 'minutes';
            if (recipe.prepTime) {
                const prepMatch = recipe.prepTime.match(/(\d+)\s*(hour|minute)/i);
                if (prepMatch) {
                    prepNum = prepMatch[1];
                    prepUnit = prepMatch[2].toLowerCase() + 's';
                }
            }
            
            let cookNum = 0, cookUnit = 'minutes';
            if (recipe.cookTime) {
                const cookMatch = recipe.cookTime.match(/(\d+)\s*(hour|minute)/i);
                if (cookMatch) {
                    cookNum = cookMatch[1];
                    cookUnit = cookMatch[2].toLowerCase() + 's';
                }
            }
            
            const formHtml = `
                <div class="form-group">
                    <label>Dish Name</label>
                    <input type="text" id="editDishName" value="${recipe.dishName}">
                </div>
                
                <div class="form-group">
                    <label>Country</label>
                    <input type="text" id="editCountry" value="${recipe.country}">
                </div>
                
                <div class="form-group">
                    <label>Category</label>
                    <select id="editCategory">
                        <option value="Appetizer" ${recipe.category === 'Appetizer' ? 'selected' : ''}>Appetizer</option>
                        <option value="Entree" ${recipe.category === 'Entree' ? 'selected' : ''}>Entree</option>
                        <option value="Dessert" ${recipe.category === 'Dessert' ? 'selected' : ''}>Dessert</option>
                        <option value="Drink" ${recipe.category === 'Drink' ? 'selected' : ''}>Drink</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Prep Time</label>
                    <div class="duration-group">
                        <input type="number" id="editPrepDuration" value="${prepNum}" min="0">
                        <select id="editPrepUnit">
                            <option value="minutes" ${prepUnit === 'minutes' ? 'selected' : ''}>Minutes</option>
                            <option value="hours" ${prepUnit === 'hours' ? 'selected' : ''}>Hours</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Cook Time</label>
                    <div class="duration-group">
                        <input type="number" id="editCookDuration" value="${cookNum}" min="0">
                        <select id="editCookUnit">
                            <option value="minutes" ${cookUnit === 'minutes' ? 'selected' : ''}>Minutes</option>
                            <option value="hours" ${cookUnit === 'hours' ? 'selected' : ''}>Hours</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Ingredients</label>
                    <textarea id="editIngredients">${recipe.ingredients}</textarea>
                </div>
                
                <div class="form-group">
                    <label>Instructions</label>
                    <textarea id="editInstructions">${recipe.instructions}</textarea>
                </div>
                
                <div class="form-group">
                    <label>Notes</label>
                    <textarea id="editNotes">${recipe.notes || ''}</textarea>
                </div>
                
                <div class="form-group">
                    <label>Photo</label>
                    ${recipe.photo ? `<img src="${recipe.photo}" style="max-width: 200px; max-height: 200px; border-radius: 8px; margin-bottom: 10px; display: block;">` : '<p style="color: #999;">No photo</p>'}
                    <input type="file" id="editPhoto" accept="image/*">
                    <p style="font-size: 12px; color: #666; margin-top: 5px;">Upload new photo to replace (auto-crops to 4:3)</p>
                </div>
            `;
            
            document.getElementById('editForm').innerHTML = formHtml;
            document.getElementById('editModal').classList.add('active');
        }
        
        function closeEditModal() {
            document.getElementById('editModal').classList.remove('active');
            currentEditIndex = -1;
        }
        
        function formatDuration(duration, unit) {
            const num = parseInt(duration);
            if (num === 0) return '0 minutes';
            if (num === 1) return unit === 'hours' ? '1 hour' : '1 minute';
            return `${num} ${unit}`;
        }
        
        async function cropAndResizeImage(file) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        
                        // Target 4:3 aspect ratio, max 800px width
                        const targetAspect = 4 / 3;
                        const sourceAspect = img.width / img.height;
                        
                        let sourceWidth, sourceHeight, sourceX, sourceY;
                        
                        if (sourceAspect > targetAspect) {
                            // Image is wider - crop sides
                            sourceHeight = img.height;
                            sourceWidth = img.height * targetAspect;
                            sourceX = (img.width - sourceWidth) / 2;
                            sourceY = 0;
                        } else {
                            // Image is taller - crop top/bottom
                            sourceWidth = img.width;
                            sourceHeight = img.width / targetAspect;
                            sourceX = 0;
                            sourceY = (img.height - sourceHeight) / 2;
                        }
                        
                        // Resize to max 800px width
                        const targetWidth = Math.min(800, sourceWidth);
                        const targetHeight = targetWidth / targetAspect;
                        
                        canvas.width = targetWidth;
                        canvas.height = targetHeight;
                        
                        ctx.drawImage(img, sourceX, sourceY, sourceWidth, sourceHeight, 0, 0, targetWidth, targetHeight);
                        
                        canvas.toBlob((blob) => {
                            resolve(blob);
                        }, 'image/jpeg', 0.8);
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            });
        }
        
        async function uploadToImgBB(file) {
            const processedBlob = await cropAndResizeImage(file);
            
            const formData = new FormData();
            formData.append('image', processedBlob);
            
            const response = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`, {
                method: 'POST',
                body: formData
            });
            
            const data = await response.json();
            
            if (data.success) {
                return data.data.url;
            } else {
                throw new Error('Failed to upload image');
            }
        }
        
        async function saveEditedRecipe() {
            if (currentEditIndex === -1) return;
            
            try {
                const dishName = document.getElementById('editDishName').value;
                const country = document.getElementById('editCountry').value;
                const category = document.getElementById('editCategory').value;
                
                const prepDuration = document.getElementById('editPrepDuration').value;
                const prepUnit = document.getElementById('editPrepUnit').value;
                const prepTime = formatDuration(prepDuration, prepUnit);
                
                const cookDuration = document.getElementById('editCookDuration').value;
                const cookUnit = document.getElementById('editCookUnit').value;
                const cookTime = formatDuration(cookDuration, cookUnit);
                
                const ingredients = document.getElementById('editIngredients').value;
                const instructions = document.getElementById('editInstructions').value;
                const notes = document.getElementById('editNotes').value;
                const photoFile = document.getElementById('editPhoto').files[0];
                
                let photoURL = cookbook.approved[currentEditIndex].photo;
                
                if (photoFile) {
                    photoURL = await uploadToImgBB(photoFile);
                }
                
                cookbook.approved[currentEditIndex] = {
                    ...cookbook.approved[currentEditIndex],
                    dishName,
                    country,
                    category,
                    prepTime,
                    cookTime,
                    ingredients,
                    instructions,
                    notes,
                    photo: photoURL
                };
                
                await window.setDoc(window.doc(window.db, 'cookbook', 'data'), cookbook);
                
                alert('Recipe updated successfully!');
                closeEditModal();
                setTimeout(() => loadManageCookbook(), 1000);
                
            } catch (error) {
                alert('Failed to save recipe: ' + error.message);
            }
        }
        
        async function deleteEditedRecipe() {
            if (currentEditIndex === -1) return;
            
            if (!confirm('Are you sure you want to delete this recipe? This cannot be undone.')) {
                return;
            }
            
            try {
                cookbook.approved.splice(currentEditIndex, 1);
                
                await window.setDoc(window.doc(window.db, 'cookbook', 'data'), cookbook);
                
                alert('Recipe deleted successfully!');
                closeEditModal();
                setTimeout(() => loadManageCookbook(), 1000);
                
            } catch (error) {
                alert('Failed to delete recipe: ' + error.message);
            }
        }
        
        function showTab(tabName) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(tabName + 'Tab').classList.add('active');
            
            if (tabName === 'cookbook') {
                loadCookbook();
            } else if (tabName === 'manage-cookbook') {
                loadManageCookbook();
            }
        }
        
        window.adminLogin = adminLogin;
        window.showDeleteModal = showDeleteModal;
        window.closeDeleteModal = closeDeleteModal;
        window.confirmDelete = confirmDelete;
        window.loadData = loadData;
        window.changeYear = changeYear;
        window.filterByCategory = filterByCategory;
        window.exportCSV = exportCSV;
        window.inspectRecipe = inspectRecipe;
        window.closeInspectModal = closeInspectModal;
        window.approveFromInspect = approveFromInspect;
        window.rejectFromInspect = rejectFromInspect;
        window.approveRecipe = approveRecipe;
        window.rejectRecipe = rejectRecipe;
        window.editRecipe = editRecipe;
        window.closeEditModal = closeEditModal;
        window.saveEditedRecipe = saveEditedRecipe;
        window.deleteEditedRecipe = deleteEditedRecipe;
        window.filterRecipes = filterRecipes;
        window.sortTable = sortTable;
        window.showTab = showTab;
    </script>
</body>
</html>
